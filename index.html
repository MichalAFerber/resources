<!-- SPDX-License-Identifier: MIT -->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- avoid favicon 404 in static hosting -->
    <link rel="icon" href="data:,">
    <title>GitHub Repo Tree Browser</title>
    <style>
        /* THEME TOKENS */
        :root {
            --bg: #121212;
            --card: #1b1b1b;
            --ink: #ededed;
            --muted: #a0a0a0;
            --accent: #121212;
            --line: #2a2a2a;
            --warn: #e9b949;
            --control: #1a1a1a
        }

        [data-theme="light"] {
            --bg: #f7f7f7;
            --card: #ffffff;
            --ink: #121212;
            --muted: #5c647a;
            --accent: #121212;
            --line: #e5e5e5;
            --control: #f2f2f2
        }

        [data-theme="dark"] {
            --bg: #121212;
            --card: #1b1b1b;
            --ink: #ededed;
            --muted: #a0a0a0;
            --accent: #121212;
            --line: #2a2a2a;
            --control: #1a1a1a
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 14px/1.5 system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"
        }

        header {
            position: sticky;
            top: 0;
            z-index: 5;
            background: rgba(18, 18, 18, .85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--line)
        }

        [data-theme="light"] header {
            background: rgba(255, 255, 255, .75)
        }

        .wrap {
            max-width: 1100px;
            margin: auto;
            padding: 12px 16px
        }

        h1 {
            font-size: 18px;
            margin: 0
        }

        #controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 8px
        }

        #controls .spacer {
            flex: 1
        }

        #themeBtn {
            display: inline-flex;
            align-items: center;
            gap: 6px
        }

        #themeBtn .mode {
            opacity: .8;
            font-size: 12px
        }

        input,
        select,
        button {
            background: var(--control);
            border: 1px solid var(--line);
            color: var(--ink);
            border-radius: 10px;
            padding: 8px 10px
        }

        [data-theme="light"] input,
        [data-theme="light"] select,
        [data-theme="light"] button {
            background: #f2f4fb
        }

        button {
            cursor: pointer;
            position: relative
        }

        main {
            max-width: 1100px;
            margin: 16px auto;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 16px;
            padding: 0 16px
        }

        @media (max-width:900px) {
            main {
                grid-template-columns: 1fr
            }
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--line);
            border-radius: 16px;
            overflow: visible
        }

        .panel header {
            position: unset;
            background: transparent;
            border: 0
        }

        .panel .head {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 14px;
            border-bottom: 1px solid var(--line)
        }

        .tree {
            padding: 8px 8px 12px 12px;
            max-height: 70vh;
            overflow: auto
        }

        details {
            padding-left: 4px
        }

        details>summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 8px
        }

        details>summary:hover {
            background: rgba(255, 255, 255, .04)
        }

        .node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 8px
        }

        .node:hover {
            background: rgba(255, 255, 255, .04)
        }

        .node a {
            color: var(--ink);
            text-decoration: none;
            flex: 1
        }

        .muted {
            color: var(--muted)
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block
        }

        .file {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .badge {
            font-size: 11px;
            border: 1px solid var(--line);
            color: var(--muted);
            padding: 2px 6px;
            border-radius: 999px
        }

        .crumbs {
            padding: 10px 14px;
            border-bottom: 1px solid var(--line);
            display: flex;
            flex-wrap: wrap;
            gap: 6px
        }

        .crumbs a {
            color: var(--ink);
            text-decoration: none
        }

        .crumbs a:hover {
            text-decoration: underline
        }

        .viewer {
            min-height: 360px
        }

        .viewer .empty {
            padding: 20px;
            color: var(--muted)
        }

        .viewer .preview {
            padding: 10px;
            display: grid;
            place-items: center
        }

        .viewer img {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            border: 1px solid var(--line)
        }

        .viewer pre {
            margin: 0;
            padding: 14px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-bottom: 1px solid var(--line)
        }

        .toolbar a,
        .toolbar button {
            color: var(--ink);
            text-decoration: none
        }

        .toolbar .group {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            padding: 12px
        }

        .thumb {
            background: var(--control);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        [data-theme="light"] .thumb {
            background: #f2f4fb
        }

        .thumb img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 8px
        }

        .thumb .name {
            font-size: 12px;
            color: var(--muted);
            word-break: break-all
        }

        .footer {
            padding: 10px 14px;
            border-top: 1px solid var(--line);
            font-size: 12px;
            color: var(--muted)
        }

        .pill {
            padding: 2px 6px;
            border-radius: 6px;
            background: var(--control);
            border: 1px solid var(--line);
            font-size: 11px
        }

        [data-theme="light"] .pill {
            background: #f2f4fb
        }

        .right {
            margin-left: auto
        }

        /* Toast */
        #toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            z-index: 100;
            background: var(--card);
            border: 1px solid var(--line);
            color: var(--ink);
            padding: 10px 12px;
            border-radius: 10px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .25);
            opacity: 0;
            transform: translateY(8px);
            transition: opacity .15s ease, transform .15s ease
        }

        #toast.show {
            opacity: 1;
            transform: translateY(0)
        }

        /* Banner */
        .banner {
            display: none;
            gap: 10px;
            align-items: flex-start;
            background: #2a1f07;
            color: #fff;
            border-bottom: 1px solid #4a360c
        }

        .banner .wrap {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .banner .warn {
            color: var(--warn)
        }

        .banner button {
            background: #3a2b08
        }

        /* Lightbox */
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .85);
            display: none;
            z-index: 50
        }

        .lightbox.open {
            display: flex
        }

        .lightbox .inner {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%
        }

        .lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            transition: transform .2s ease
        }

        .lightbox .close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #111;
            border: 1px solid #333;
            border-radius: 999px;
            padding: 8px 10px;
            cursor: pointer
        }

        .lightbox .nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px
        }

        .lightbox .prev {
            left: 16px
        }

        .lightbox .next {
            right: 16px
        }

        .btn {
            background: var(--control);
            border: 1px solid var(--line);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer
        }

        [data-theme="light"] .btn {
            background: #f2f4fb
        }

        /* Hover help tooltip (no JS) */
        .has-tip {
            position: relative
        }

        .has-tip[aria-label]::after {
            content: attr(aria-label);
            position: absolute;
            left: 50%;
            top: calc(100% + 8px);
            transform: translateX(-50%);
            background: var(--card);
            color: var(--ink);
            border: 1px solid var(--line);
            padding: 6px 8px;
            border-radius: 8px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity .12s ease;
            z-index: 20
        }

        .has-tip:hover::after {
            opacity: 1
        }

        /* Copied badge animation */
        .pop {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 999px;
            opacity: 0;
            transform: translateY(-6px);
            transition: opacity .15s ease, transform .15s ease
        }

        .pop.show {
            opacity: 1;
            transform: translateY(0)
        }
    </style>
</head>

<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
        <symbol id="dir" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M10 4l2 2h8a2 2 0 012 2v1H2V6a2 2 0 012-2h6zm12 6v8a2 2 0 01-2 2H4a2 2 0 01-2-2v-8h20z" />
        </symbol>
        <symbol id="file" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M6 2h9l5 5v13a2 2 0 01-2 2H6a2 2 0 01-2-2V4a2 2 0 012-2zm8 1.5V8h4.5L14 3.5z" />
        </symbol>
        <symbol id="img" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M21 19a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v12zm-4-8a2 2 0 10-4 0 2 2 0 004 0zM5 19l5-6 4 5 3-4 4 5H5z" />
        </symbol>
        <symbol id="home" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z" />
        </symbol>
        <symbol id="ext" viewBox="0 0 24 24">
            <path fill="currentColor"
                d="M14 3h7v7h-2V6.41l-9.29 9.3-1.42-1.42 9.3-9.29H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z" />
        </symbol>
        <symbol id="raw" viewBox="0 0 24 24">
            <path fill="currentColor" d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z" />
        </symbol>
    </svg>

    <div class="banner" id="banner">
        <div class="wrap"><span class="warn">⚠</span>
            <div id="bannerMsg">API rate limit or network issue.</div><button class="btn"
                id="bannerClose">Dismiss</button>
        </div>
    </div>

    <header>
        <div class="wrap">
            <h1>GitHub Repo Tree Browser</h1>
            <div id="controls">
                <label>Owner <input id="owner" value="MichalAFerber" /></label>
                <label>Repo <input id="repo" value="resources" /></label>
                <label>Branch <input id="branch" value="main" /></label>
                <button id="load" class="btn has-tip"
                    aria-label="Reload the tree with the Owner/Repo/Branch above">Load</button>
                <span class="spacer"></span>
                <button id="themeBtn" class="btn has-tip"
                    aria-label="Toggle theme: System → Light → Dark"><span>🌓</span><span class="mode"
                        id="themeMode">System</span></button>
                <span class="pill">Unauthenticated · public repos only · 60 req/hr</span>
            </div>
        </div>
    </header>

    <main>
        <section class="panel" id="treePanel">
            <div class="head"><strong>Folders & Files</strong><span id="treeCount" class="right muted"></span></div>
            <nav class="crumbs" id="crumbs"></nav>
            <div class="tree" id="tree"></div>
            <div class="footer">Tip: click folders to expand; click files to preview or open raw.</div>
        </section>

        <section class="panel">
            <div class="toolbar">
                <strong id="viewerTitle">Viewer</strong>
                <span id="viewerMeta" class="muted"></span>
                <div class="group">
                    <button id="copyGhUrl" class="btn has-tip" aria-label="Copy the direct file URL">Copy URL</button>
                    <button id="copyRaw" class="btn has-tip"
                        aria-label="Copy the raw file to clipboard (images paste into chat; text copies as text)">Copy
                        Raw</button>
                    <a id="downloadBtn" class="btn has-tip" aria-label="Download the raw file" href="#"
                        download>Download</a>
                </div>
                <a id="openOnGitHub" class="right btn has-tip" aria-label="Open this file on GitHub" href="#"
                    target="_blank" rel="noopener"><svg class="icon">
                        <use href="#ext" />
                    </svg> View on GitHub</a>
                <a id="openRaw" class="btn has-tip" aria-label="Open raw file in a new tab" href="#" target="_blank"
                    rel="noopener"><svg class="icon">
                        <use href="#raw" />
                    </svg> Raw</a>
            </div>
            <div class="viewer" id="viewer">
                <div class="empty">Select a file to preview. Images render inline; text files up to ~1 MB are shown;
                    others offer a raw/download link.</div>
            </div>
        </section>
    </main>

    <!-- Lightbox overlay -->
    <div class="lightbox" id="lightbox" aria-hidden="true">
        <div class="inner">
            <button class="close" id="lbClose" aria-label="Close">✕</button>
            <button class="btn nav prev" id="lbPrev" aria-label="Previous">◀</button>
            <img id="lbImg" alt="preview" />
            <button class="btn nav next" id="lbNext" aria-label="Next">▶</button>
        </div>
    </div>

    <script>
        const els = {
            owner: document.getElementById('owner'),
            repo: document.getElementById('repo'),
            branch: document.getElementById('branch'),
            loadBtn: document.getElementById('load'),
            themeBtn: document.getElementById('themeBtn'),
            themeMode: document.getElementById('themeMode'),
            tree: document.getElementById('tree'),
            crumbs: document.getElementById('crumbs'),
            treeCount: document.getElementById('treeCount'),
            viewer: document.getElementById('viewer'),
            viewerTitle: document.getElementById('viewerTitle'),
            viewerMeta: document.getElementById('viewerMeta'),
            openGH: document.getElementById('openOnGitHub'),
            openRaw: document.getElementById('openRaw'),
            downloadBtn: document.getElementById('downloadBtn'),
            copyGhUrl: document.getElementById('copyGhUrl'),
            copyRaw: document.getElementById('copyRaw'),
            banner: document.getElementById('banner'),
            bannerMsg: document.getElementById('bannerMsg'),
            bannerClose: document.getElementById('bannerClose'),
            lb: document.getElementById('lightbox'),
            lbImg: document.getElementById('lbImg'),
            lbClose: document.getElementById('lbClose'),
            lbPrev: document.getElementById('lbPrev'),
            lbNext: document.getElementById('lbNext'),
            toast: document.createElement('div')
        };
        els.toast.id = 'toast';
        document.body.appendChild(els.toast);

        const IMAGE_EXT = [".png", ".jpg", ".jpeg", ".gif", ".webp", ".avif", ".svg"];
        const TEXT_EXT = [".md", ".txt", ".json", ".yml", ".yaml", ".csv", ".js", ".ts", ".css", ".html", ".xml", ".sh", ".py"];

        function apiURL(owner, repo, path, branch) {
            const p = path ? `/${encodeURIComponent(path).replace(/%2F/g, '/')}` : '';
            return `https://api.github.com/repos/${owner}/${repo}/contents${p}?ref=${encodeURIComponent(branch)}`;
        }
        function rawURL(owner, repo, path, branch) {
            return `https://raw.githubusercontent.com/${owner}/${repo}/${encodeURIComponent(branch)}/${path}`;
        }
        function ghURL(owner, repo, path, branch) {
            const base = `https://github.com/${owner}/${repo}`;
            return path ? `${base}/blob/${encodeURIComponent(branch)}/${path}` : base;
        }

        // --- Safe URL state helpers ---
        function setQuery(path) {
            const params = new URLSearchParams(location.search);
            if (path) params.set('path', path); else params.delete('path');
            try {
                if (location.protocol !== 'about:') {
                    const base = `${location.origin}${location.pathname}`;
                    const query = params.toString();
                    const newUrl = query ? `${base}?${query}` : base;
                    history.replaceState(null, '', newUrl);
                    return; // success
                }
            } catch (e) { /* fall back to hash */ }
            if (path) { location.hash = '#path=' + encodeURIComponent(path); }
            else if (location.hash.startsWith('#path=')) { location.hash = ''; }
        }
        function getQueryPath() {
            const sp = new URLSearchParams(location.search);
            if (sp.has('path')) return sp.get('path') || '';
            if (location.hash.startsWith('#path=')) {
                try { return decodeURIComponent(location.hash.slice(6)); } catch { return location.hash.slice(6); }
            }
            return '';
        }

        async function fetchDir(path = "") {
            let res;
            try { res = await fetch(apiURL(els.owner.value, els.repo.value, path, els.branch.value)); }
            catch (netErr) { showBanner('Network error while contacting GitHub API.'); throw netErr; }
            if (res.status === 403) {
                const remaining = res.headers.get('X-RateLimit-Remaining');
                const reset = res.headers.get('X-RateLimit-Reset');
                if (remaining === '0' && reset) {
                    const secs = Math.max(0, parseInt(reset, 10) - Math.floor(Date.now() / 1000));
                    const mins = Math.ceil(secs / 60);
                    showBanner(`GitHub API rate limit reached. Try again in about ${mins} minute(s).`);
                } else { showBanner('Access denied or temporarily rate limited by GitHub API.'); }
            }
            if (!res.ok) { throw new Error(await res.text()); }
            return res.json();
        }

        function iconFor(item) {
            if (item.type === 'dir') return '#dir';
            const name = item.name.toLowerCase();
            if (IMAGE_EXT.some(ext => name.endsWith(ext))) return '#img';
            return '#file';
        }

        function renderCrumbs(path) {
            const parts = path ? path.split('/') : [];
            let acc = '';
            els.crumbs.innerHTML = '';
            const home = document.createElement('a');
            home.innerHTML = `<svg class="icon"><use href="#home"/></svg>`;
            home.href = '#';
            home.onclick = (e) => { e.preventDefault(); loadPath(''); }
            els.crumbs.appendChild(home);
            parts.forEach((seg, i) => {
                const span = document.createElement('span');
                span.textContent = ' / ';
                els.crumbs.appendChild(span);
                acc += (i ? '/' : '') + seg;
                const a = document.createElement('a');
                a.textContent = seg;
                a.href = '#';
                a.onclick = (e) => { e.preventDefault(); loadPath(acc); }
                els.crumbs.appendChild(a);
            })
        }

        const dirImageCache = new Map(); // parentPath -> [items]
        function repoKey() { return `${els.owner.value}/${els.repo.value}@${els.branch.value}`; }
        function openDirsKey() { return `repoTree:${repoKey()}:openDirs`; }
        function loadOpenDirs() { try { return new Set(JSON.parse(localStorage.getItem(openDirsKey()) || '[]')); } catch { return new Set(); } }
        function saveOpenDirs(set) { try { localStorage.setItem(openDirsKey(), JSON.stringify(Array.from(set))); } catch { } }

        async function buildList(path, container) {
            container.textContent = 'Loading…';
            try {
                const items = await fetchDir(path);
                items.sort((a, b) => (a.type === b.type ? a.name.localeCompare(b.name) : a.type === 'dir' ? -1 : 1));
                els.treeCount.textContent = `${items.length} items`;
                container.innerHTML = '';

                const openSet = loadOpenDirs();

                for (const item of items) {
                    if (item.type === 'dir') {
                        const d = document.createElement('details');
                        const s = document.createElement('summary');
                        s.innerHTML = `<svg class="icon"><use href="${iconFor(item)}"/></svg><span>${item.name}</span>`;
                        d.appendChild(s);
                        const inner = document.createElement('div');
                        inner.style.paddingLeft = '14px';
                        inner.textContent = '…';
                        d.appendChild(inner);
                        d.addEventListener('toggle', async () => {
                            const key = item.path;
                            const set = loadOpenDirs();
                            if (d.open) { set.add(key); saveOpenDirs(set); if (inner.textContent === '…') { await buildList(item.path, inner); } }
                            else { set.delete(key); saveOpenDirs(set); }
                        });
                        if (openSet.has(item.path)) {
                            d.open = true; buildList(item.path, inner).catch(() => { });
                        }
                        container.appendChild(d);
                    } else {
                        const row = document.createElement('div');
                        row.className = 'node file';
                        row.innerHTML = `<svg class="icon"><use href="${iconFor(item)}"/></svg><a href="#">${item.name}</a><span class="badge muted">${Math.max(1, Math.round(item.size / 1024))} KB</span>`;
                        const link = row.querySelector('a');
                        link.onclick = (e) => { e.preventDefault(); openFile(item) };
                        container.appendChild(row);
                    }
                }
                const imgItems = items.filter(it => it.type === 'file' && IMAGE_EXT.some(ext => it.name.toLowerCase().endsWith(ext)));
                dirImageCache.set(path || '', imgItems);
                if (imgItems.length >= 4) {
                    const grid = document.createElement('div');
                    grid.className = 'grid';
                    for (const it of imgItems.slice(0, 40)) {
                        const t = document.createElement('a');
                        t.className = 'thumb';
                        t.href = '#';
                        t.onclick = (e) => { e.preventDefault(); openFile(it) };
                        const img = document.createElement('img');
                        img.loading = 'lazy';
                        img.src = rawURL(els.owner.value, els.repo.value, it.path, els.branch.value);
                        const name = document.createElement('div'); name.className = 'name'; name.textContent = it.name;
                        t.append(img, name);
                        grid.appendChild(t);
                    }
                    const label = document.createElement('div');
                    label.className = 'muted';
                    label.style.padding = '8px 12px 0';
                    label.textContent = 'Image preview';
                    container.append(label, grid);
                }
            } catch (err) {
                container.innerHTML = `<div class=\"muted\" style=\"padding:8px 12px\">${err}</div>`;
            }
        }

        async function getSiblingImages(filePath) {
            const parent = filePath.split('/').slice(0, -1).join('/');
            if (dirImageCache.has(parent)) return dirImageCache.get(parent);
            try {
                const items = await fetchDir(parent);
                const imgs = items.filter(it => it.type === 'file' && IMAGE_EXT.some(ext => it.name.toLowerCase().endsWith(ext)));
                dirImageCache.set(parent, imgs); return imgs;
            }
            catch { return []; }
        }

        let lastOpenedItem = null;
        async function openFile(item) {
            lastOpenedItem = item;
            const owner = els.owner.value, repo = els.repo.value, branch = els.branch.value;
            const raw = rawURL(owner, repo, item.path, branch);
            const gh = ghURL(owner, repo, item.path, branch);
            els.viewerTitle.textContent = item.name;
            els.viewerMeta.textContent = ` · ${Math.max(1, Math.round(item.size / 1024))} KB`;
            els.openGH.href = gh; els.openRaw.href = raw;
            els.downloadBtn.href = raw; els.downloadBtn.setAttribute('download', item.name);
            const lower = item.name.toLowerCase();
            if (IMAGE_EXT.some(ext => lower.endsWith(ext))) {
                els.viewer.innerHTML = `<div class=\"preview\"><img id=\"previewImg\" alt=\"${item.name}\" src=\"${raw}\"></div>`;
                const prevImg = document.getElementById('previewImg');
                prevImg.addEventListener('click', () => openLightbox(item.path));
            } else if (TEXT_EXT.some(ext => lower.endsWith(ext)) && item.size < 1024 * 1024) {
                els.viewer.innerHTML = '<div class="empty">Loading text…</div>';
                try {
                    const res = await fetch(raw); const text = await res.text();
                    const pre = document.createElement('pre'); pre.textContent = text; els.viewer.innerHTML = ''; els.viewer.appendChild(pre);
                }
                catch (e) { els.viewer.innerHTML = `<div class=\"empty\">Could not load text. <a href=\"${raw}\" target=\"_blank\" rel=\"noopener\">Open raw</a></div>` }
            } else {
                els.viewer.innerHTML = `<div class=\"empty\">Preview not available. Use <a href=\"${gh}\" target=\"_blank\" rel=\"noopener\">View on GitHub</a> or <a href=\"${raw}\" target=\"_blank\" rel=\"noopener\">open raw</a>.</div>`
            }
            setQuery(item.path);
            document.querySelector('section.panel:nth-of-type(2)').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadPath(path) {
            renderCrumbs(path);
            els.tree.innerHTML = '';
            await buildList(path, els.tree);
            const itemName = path.split('/').pop();
            const isMaybeFile = itemName && itemName.includes('.') && !path.endsWith('/');
            if (isMaybeFile) {
                try {
                    const parent = path.split('/').slice(0, -1).join('/');
                    const items = await fetchDir(parent);
                    const found = items.find(i => i.path === path); if (found) openFile(found);
                } catch { }
            }
        }

        function showBanner(msg) { els.bannerMsg.textContent = msg; els.banner.style.display = 'block'; }
        function showToast(msg) { els.toast.textContent = msg; els.toast.classList.add('show'); clearTimeout(showToast._t); showToast._t = setTimeout(() => els.toast.classList.remove('show'), 1500); }

        // Copied badge helper
        function popBadge(el, text = 'Copied!') {
            const span = document.createElement('span'); span.className = 'pop'; span.textContent = text; el.appendChild(span);
            requestAnimationFrame(() => span.classList.add('show'));
            setTimeout(() => { span.classList.remove('show'); setTimeout(() => span.remove(), 200); }, 900);
        }

        // ----- Clipboard helpers (robust to sandbox/permissions) -----
        function canUseAsyncClipboard() {
            return !!(window.isSecureContext && navigator.clipboard && typeof navigator.clipboard.writeText === 'function');
        }
        async function copyText(text) {
            // Try Async Clipboard API
            if (canUseAsyncClipboard()) {
                try { await navigator.clipboard.writeText(text); return true; }
                catch (e) { /* fall through to fallback */ }
            }
            // Fallback: execCommand on a hidden textarea (text only)
            try {
                const ta = document.createElement('textarea');
                ta.value = text; ta.setAttribute('readonly', ''); ta.style.position = 'fixed'; ta.style.opacity = '0'; ta.style.left = '-9999px';
                document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true;
            } catch (e) { return false; }
        }
        function canWriteBinaryClipboard() {
            return !!(window.isSecureContext && navigator.clipboard && window.ClipboardItem);
        }

        // Theme
        const THEME_KEY = 'repoTree:theme';
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        function applyTheme(mode) { const m = mode === 'system' ? (prefersDark && prefersDark.matches ? 'dark' : 'light') : mode; document.documentElement.setAttribute('data-theme', m); els.themeMode.textContent = mode.charAt(0).toUpperCase() + mode.slice(1); }
        function getTheme() { return localStorage.getItem(THEME_KEY) || 'system'; }
        function setTheme(mode) { localStorage.setItem(THEME_KEY, mode); applyTheme(mode); }

        // Self-tests (optional)
        function runSelfTests() {
            const results = [];
            const prevHash = location.hash;
            try { setQuery('test/path.png'); const got = getQueryPath(); results.push(['set/get path roundtrip', got === 'test/path.png', got]); }
            catch (e) { results.push(['setQuery did not throw', false, String(e)]); }
            finally { if (prevHash !== location.hash) location.hash = prevHash; }
            const set = loadOpenDirs(); const before = set.size; set.add('foo/bar'); saveOpenDirs(set); const after = loadOpenDirs().has('foo/bar');
            results.push(['openDirs persistence', after === true, `before=${before}`]);
            // Clipboard guard tests (do not actually write)
            results.push(['canUseAsyncClipboard is boolean', typeof canUseAsyncClipboard() === 'boolean', canUseAsyncClipboard()]);
            results.push(['canWriteBinaryClipboard is boolean', typeof canWriteBinaryClipboard() === 'boolean', canWriteBinaryClipboard()]);
            const ru = rawURL(els.owner.value, els.repo.value, 'folder/pic.png', els.branch.value);
            results.push(['rawURL format check', /raw\.githubusercontent\.com\//.test(ru) && /pic\.png$/.test(ru), ru]);
            console.group('Self-tests'); for (const [name, ok, detail] of results) { if (ok) console.log('✔', name, detail); else console.error('✘', name, 'detail:', detail); } console.groupEnd();
        }

        async function boot() {
            const params = new URLSearchParams(location.search);
            if (params.has('owner')) els.owner.value = params.get('owner');
            if (params.has('repo')) els.repo.value = params.get('repo');
            if (params.has('branch')) els.branch.value = params.get('branch');
            const path = getQueryPath();
            if (params.get('selftest') === '1') runSelfTests();
            applyTheme(getTheme());
            await loadPath(path);
        }

        // Events
        els.loadBtn.addEventListener('click', () => loadPath(''));
        window.addEventListener('popstate', () => loadPath(getQueryPath()));
        window.addEventListener('hashchange', () => loadPath(getQueryPath()));
        els.bannerClose.addEventListener('click', () => els.banner.style.display = 'none');

        els.themeBtn.addEventListener('click', () => { const cur = getTheme(); const next = cur === 'system' ? 'light' : (cur === 'light' ? 'dark' : 'system'); setTheme(next); showToast('Theme: ' + next); });
        if (prefersDark) prefersDark.addEventListener('change', () => { if (getTheme() === 'system') applyTheme('system'); });

        // Toolbar actions (with robust clipboard handling)
        els.copyGhUrl.addEventListener('click', async (e) => {
            e.preventDefault(); if (!lastOpenedItem) return;
            // Copy the direct file URL (raw URL), not the GitHub page URL
            const url = rawURL(els.owner.value, els.repo.value, lastOpenedItem.path, els.branch.value);
            const ok = await copyText(url);
            if (ok) { showToast('Copied file URL'); popBadge(els.copyGhUrl); }
            else { showToast('Clipboard blocked. Unable to copy.'); }
        });

        els.copyRaw.addEventListener('click', async (e) => {
            e.preventDefault(); if (!lastOpenedItem) return;
            const raw = rawURL(els.owner.value, els.repo.value, lastOpenedItem.path, els.branch.value);
            try {
                // Prefer binary image/text copy when allowed
                if (canWriteBinaryClipboard()) {
                    const res = await fetch(raw);
                    const blob = await res.blob();
                    if (blob.type.startsWith('image/')) {
                        try { await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]); showToast('Image copied'); popBadge(els.copyRaw); return; }
                        catch (err) { /* fall through to text/url fallback */ }
                    }
                    if (blob.type.startsWith('text/')) {
                        const txt = await blob.text();
                        const ok = await copyText(txt);
                        if (ok) { showToast('Text copied'); popBadge(els.copyRaw); return; }
                    }
                }
                // Fallbacks when binary clipboard is disallowed or throws NotAllowedError
                const okURL = await copyText(raw);
                if (okURL) { showToast('Copied raw URL (clipboard blocked for data)'); popBadge(els.copyRaw); }
                else { showToast('Clipboard blocked. Unable to copy.'); }
            } catch (err) {
                // Network or other
                console.error(err);
                const okURL = await copyText(raw);
                if (okURL) { showToast('Copied raw URL'); popBadge(els.copyRaw); }
                else { showToast('Copy failed'); }
            }
        });

        els.downloadBtn.addEventListener('click', async (e) => {
            if (!lastOpenedItem) return; e.preventDefault();
            try {
                showToast('Downloading…');
                const raw = rawURL(els.owner.value, els.repo.value, lastOpenedItem.path, els.branch.value);
                const res = await fetch(raw, { cache: 'no-store' });
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = lastOpenedItem.name; document.body.appendChild(a); a.click(); a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            } catch (err) { console.error(err); showToast('Download failed'); }
        });

        // Lightbox interactions
        function toggleZoom() { const img = els.lbImg; img.style.transform = img.style.transform ? '' : 'scale(1.5)'; }
        function closeLightbox() { els.lb.classList.remove('open'); els.lb.setAttribute('aria-hidden', 'true'); document.removeEventListener('keydown', keyNav); }
        function keyNav(e) { if (e.key === 'Escape') closeLightbox(); if (e.key === 'ArrowLeft') stepLightbox(-1); if (e.key === 'ArrowRight') stepLightbox(1); }

        let lbState = { parent: '', list: [], index: 0 };
        async function openLightbox(filePath) { const parent = filePath.split('/').slice(0, -1).join('/'); const list = await getSiblingImages(filePath); const idx = Math.max(0, list.findIndex(x => x.path === filePath)); lbState = { parent, list, index: idx }; updateLightbox(); els.lb.classList.add('open'); els.lb.setAttribute('aria-hidden', 'false'); document.addEventListener('keydown', keyNav); }
        function stepLightbox(delta) { if (!lbState.list.length) return; lbState.index = (lbState.index + delta + lbState.list.length) % lbState.list.length; updateLightbox(); }
        function updateLightbox() { const cur = lbState.list[lbState.index]; if (!cur) return; els.lbImg.src = rawURL(els.owner.value, els.repo.value, cur.path, els.branch.value); els.lbImg.alt = cur.name; }
        els.lbClose.addEventListener('click', closeLightbox);
        els.lbPrev.addEventListener('click', () => stepLightbox(-1));
        els.lbNext.addEventListener('click', () => stepLightbox(1));
        els.lbImg.addEventListener('click', toggleZoom);
        els.lb.addEventListener('click', (e) => { if (e.target === els.lb) closeLightbox(); });

        // expose for preview image click
        window.openLightbox = openLightbox;

        // GO
        boot();
    </script>
</body>

</html>